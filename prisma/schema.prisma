generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Vehicle {
  id           String         @id @default(cuid())
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  brand        String
  model        String
  year         Int
  plateNumber  String
  color        String
  mileage      Int?
  maintenance  Maintenance[]
  reminders    Reminder[]
  fuelRecords  FuelRecord[]
  trafficFines TrafficFine[]
  documents    Document[]
}

model Maintenance {
  id                 String   @id @default(cuid())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  vehicleId          String
  vehicle            Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  serviceType        String
  date               DateTime
  mileage            Int?
  cost               Float?
  notes              String?
  nextServiceMileage Int?
  invoiceAmount      Float?
  paymentStatus      PaymentStatus @default(NOT_REQUIRED)
  paymentId          String?       @unique
  payment            Payment?      @relation("MaintenancePayment", fields: [paymentId], references: [id])
}

model Reminder {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  vehicleId String
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  title     String
  dueDate   DateTime
  type      String
  status    String
}

model FuelRecord {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  vehicleId String
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  date      DateTime
  liters    Float
  cost      Float
  mileage   Int
  fullTank  Boolean  @default(true)
}

model TrafficFine {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  vehicleId         String
  vehicle           Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  fineType          String
  amount            Float
  status            String
  location          String
  date              DateTime
  dueDate           DateTime
  paymentReference  String?
  paymentStatus     PaymentStatus @default(PENDING)
  paymentId         String?       @unique
  payment           Payment?      @relation("TrafficFinePayment", fields: [paymentId], references: [id])
}

model MarketplaceListing {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  title          String
  type           String
  price          Float
  mileage        Int
  brand          String
  model          String
  year           Int
  color          String
  transmission   String
  fuelType       String
  description    String?
  phoneWhatsApp  String
  negotiable     Boolean   @default(true)
}

model Notification {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  title     String
  message   String
  read      Boolean  @default(false)
}

model Document {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  vehicleId String
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  title     String
  type      String
  expiryDate DateTime?
  notes     String?
}

model ServiceCenter {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  name        String
  address     String
  services    String
  rating      Float
  reviewCount Int
}

model User {
  id                    String   @id @default(cuid())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  name                  String
  phone                 String   @unique
  email                 String?  @unique
  notificationsEnabled  Boolean  @default(true)
  darkMode              Boolean  @default(false)
  passwordHash          String?
  phoneVerifiedAt       DateTime?
  emailVerifiedAt       DateTime?
  role                  UserRole @default(OWNER)
  lastLoginAt           DateTime?
  otpSecret             Json?
  sessions              Session[]
  payments              Payment[]
  otpLogs               OTPLog[]
}

model Session {
  id               String    @id
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshTokenHash String
  expiresAt        DateTime
  revokedAt        DateTime?
  ip               String?
  userAgent        String?
}

model OTPLog {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel    OTPChannel
  codeHash   String
  expiresAt  DateTime
  consumedAt DateTime?
  meta       Json?
}

model Payment {
  id          String            @id @default(cuid())
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetType  PaymentTargetType
  targetId    String?
  status      PaymentStatus     @default(PENDING)
  provider    PaymentProvider   @default(MOCK)
  reference   String            @unique
  amount      Decimal           @db.Decimal(10, 2)
  currency    String            @default("EGP")
  expiresAt   DateTime?
  payload     Json?
  trafficFine TrafficFine? @relation("TrafficFinePayment")
  maintenance Maintenance? @relation("MaintenancePayment")
}

enum UserRole {
  OWNER
  VIEWER
}

enum OTPChannel {
  SMS
  EMAIL
}

enum PaymentStatus {
  PENDING
  PAID
  CANCELLED
  EXPIRED
  NOT_REQUIRED
}

enum PaymentProvider {
  MOCK
  FAWRY
}

enum PaymentTargetType {
  TRAFFIC_FINE
  MAINTENANCE
}
